Bootstrap: docker
From: nvidia/cuda:12.4.1-cudnn-devel-ubuntu22.04

%files
    ../envs/maniskill3/environment.yaml /my_container/setup/envs/maniskill3/environment.yaml
    ../requirements.txt /my_container/setup/requirements.txt
%post
        export DEBIAN_FRONTEND=noninteractive
        apt-get update \
        && apt-get install -y --no-install-recommends \
                build-essential \
                software-properties-common \
                ca-certificates \
                cmake \
                wget \
                curl \
                unzip \
                libegl1 \
                libxext6 \
                libjpeg-dev \
                libpng-dev  \
                libvulkan1 \
                vulkan-tools \
        && rm -rf /var/lib/apt/lists/*
        
        # Update and register CA certificates if not done already, needed to avoid SSL error on narval cluster
        update-ca-certificates
        mkdir -p /etc/pki/tls/certs
        ln -s /etc/ssl/certs/ca-certificates.crt /etc/pki/tls/certs/ca-bundle.crt
        
        # Install Miniconda3
        wget https://repo.anaconda.com/miniconda/Miniconda3-latest-Linux-x86_64.sh -O /my_container/setup/miniconda.sh
        bash /my_container/setup/miniconda.sh -b -p /opt/conda
        rm /my_container/setup/miniconda.sh

        export PATH="/opt/conda/bin:$PATH"

        # Create some directories for code and dataset
        # This allows us to bind these to whatever directory the cluster uses on the fly when launching a task
        mkdir /code/
        mkdir /dataset/
        mkdir /tmp_job_data/
        mkdir /final_job_data/

        # Create conda env
        cd /my_container/setup/
        conda env create --file envs/maniskill3/environment.yaml -y
        . /opt/conda/etc/profile.d/conda.sh
        conda activate /opt/conda/envs/maniskill3_env

        # Install dependencies
        pip install -r requirements.txt
        # If you use opencv (or if a lib needs it), make sure to only install the headless version
        pip uninstall -y opencv-python
        pip install --no-cache-dir opencv-python-headless

        conda clean -afy

        # This downloads the physx GPU binary required by SAPIEN
        # Manually downloading at build time avoids needing an internet connection at runtime
        # This is equivalent to doing https://github.com/haosulab/ManiSkill/blob/6226567ce326625fa6eacf9aeb3f4008e4339f7e/docker/Dockerfile#L49 but doesn't require to have a GPU at build time
        mkdir -p /my_container/.sapien/physx/105.1-physx-5.3.1.patch0/
        wget https://github.com/sapien-sim/physx-precompiled/releases/download/105.1-physx-5.3.1.patch0/linux-so.zip --directory-prefix=/my_container/.sapien/physx/105.1-physx-5.3.1.patch0/
        unzip /my_container/.sapien/physx/105.1-physx-5.3.1.patch0/linux-so.zip -d /my_container/.sapien/physx/105.1-physx-5.3.1.patch0/
        rm /my_container/.sapien/physx/105.1-physx-5.3.1.patch0/linux-so.zip

%environment
        export SHELL=/bin/bash
        export DEBIAN_FRONTEND=noninteractive
        export PATH="/opt/conda/envs/maniskill3_env/bin:/opt/conda/bin:$PATH"
        export NVIDIA_DRIVER_CAPABILITIES=all
        # This allows using our code in python files (similar to pip install -e /code/Maniskill3-Singularity-Example/ if we had a pyproject.toml)
        # See the imports from scripts/train_rl.py for an example on how to import stuff from src/my_lib
        # This avoids needing to use pip install which might be denied on some clusters (eg: if only pre-defined libraries are allowed)
        export PYTHONPATH="/code/Maniskill3-Singularity-Example/src/:$PYTHONPATH"
%runscript
        # Singularity automatically binds the home directory, so it's possible that physx GPU binary already exists
        rm -rf $HOME/.sapien/
        # We manually copy the physx GPU binary we downloaded at build time (which is compatible with SAPIEN)
        mkdir -p $HOME/.sapien/
        cp -r /my_container/.sapien/* $HOME/.sapien/
        # We activate our conda env
        . /opt/conda/etc/profile.d/conda.sh
        conda activate /opt/conda/envs/maniskill3_env
        # We move where our code is (arbitrary choice, you can do whatever you want here like hardcoding python your_code/scripts/train_rl.py for instance or executing a bash file https://stackoverflow.com/a/51443825/7270039)
        cd /code/Maniskill3-Singularity-Example/
        # We execute the command that will be passed during singularity run (eg: python scripts/train_rl.py)
        exec $@
